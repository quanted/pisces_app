<style>

    #main-content {
        max-width: 90vw !important;
    }

    div.main-column {
        padding-left: 0 !important;
        width: 95% !important;
    }

    #view_block {
        display: block;
        height: 60vh;
    }

    #map {
        width: 100%;
        height: 88%;
    }

    #mapDiv {
        display: inline-block;
        float: left;
        width: 65%;
        height: 100%;
        {#height: 625px;#}
        {#max-height: 625px;#}
        border-radius: 10px;
        border-color: black;
        border-bottom-width: 1px;
    }

    #basemaps-wrapper {
        background: white;
        padding: 10px;
        width: 100%;
    }

    {#datatables font size#}
    th {
        font-size: 12px;
    }

    td {
        font-size: 11px;
    }

    {#remove all EPA css transitions for leaflet map#}
    div.mapNoTransition * {
        -o-transition-property: none !important;
        -moz-transition-property: none !important;
        -ms-transition-property: none !important;
        -webkit-transition-property: none !important;
        transition-property: none !important;
        transition: none !important;
    }

    div.fishSearch {
        display: inline-block;
        float: right;
        border-style: solid;
        border-width: 1px;
        width: 33%;
        margin: 1px 1px;
        height: 60vh;
        {#height: 625px;#}
        {#max-height: 625px;#}
        padding: 1.3529em 1em;
        border-radius: 10px;
    }

    input.fishSearchBox {
        font-size: 12px;
        float: left;
        display: inline-block;
        width: 75%;
        height: 22px;
        padding-left: 5px;
    }

    input.fishSearchButton {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB2aWV3Qm94PSIwIDAgMjg5LjEyMjIyIDI4OC4yOTYwOCIgaGVpZ2h0PSIxMnB4IiB3aWR0aD0iMTJweCI+DQo8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjYzLjQzMTIsLTM4OS42MzEyNCkiPg0KPHBhdGggc3Ryb2tlLXdpZHRoPSI5Ljc1NjE3MzEzIiBmaWxsPSIjRkZGIiBkPSJNMjk1LjkzODk5LDQyMi4wODZjLTQzLjI3Mjk5LDQzLjI3Mi00My4zNzg5OSwxMTQuMTU5LTAuMTA1OTgsMTU3LjQzMjAxLDM2LjY2Mjk5LDM2LjY2MzAyLDkzLjIwMTk5LDQyLjI1LDEzNS45MjA5OSwxNi43NjU5OWw3Ni4zNDM5OSw3NC4yMzQ5OGMxMC41MDY5OSwxMC4xOTgsMjcuMDg0OTksOS44MjEwNSwzNy4xMTY5Ny0wLjg0Mzk5LDEwLjAzMzAyLTEwLjY2NDk4LDkuNzcwMDItMjcuNDQ1OTktMC43Mzc5Ny0zNy42NDM5OGwtNzUuMTgyOTgtNzIuODY0MDJjMjYuMzYwOTktNDIuODQ2OTgsMjEuMDA3OTktMTAwLjA0NDk4LTE2LjAyODAyLTEzNy4wODA5OS00My4yNzI5OC00My4yNzMwMS0xMTQuMDU0OTktNDMuMjczMDEtMTU3LjMyNywwem0zMS43Mzg5OSwzMS43MzkwMWMyNi4xMDIwMi0yNi4xMDIwMiw2Ny43NDYwMy0yNi4xMDIwMiw5My44NDgwMiwwLDI2LjEwMTk5LDI2LjEwMTk5LDI2LjEwMTk5LDY3Ljc0NTk4LDAsOTMuODQ3OTYtMjYuMTAxOTksMjYuMTAyMDYtNjcuNzQ2LDI2LjEwMjA2LTkzLjg0ODAyLDAtMjYuMTAxOTktMjYuMTAxOTktMjYuMTAxOTktNjcuNzQ1OTcsMC05My44NDc5NnoiLz4NCjwvZz4NCjwvc3ZnPg==");
        background-color: #02bfe7;
        background-repeat: no-repeat;
        background-size: 10px 10px;
        background-position: 50%;
        border-color: #02bfe7;
        float: left;
        display: inline-block;
        width: 10px;
        height: 22px;
        margin-left: 0 !important;
        border-radius: 0 3px 3px 0 !important;
    }

    .fishTable {
        height: 100%;
    }

    #fishTable_wrapper {
        height: 82%;
    }
    .dataTables_scroll {
        display: contents;
    }

    #fishTable thead * {
        font-size: 10px;
    }

    #fishTable tbody {
        cursor: pointer;
    }

    #fishTable thead *, tr *, td * {
        border: 0 !important;
        text-align: center !important;
    }

    #fishTable td * {
        width: 50% !important;
    }

    #fishTable tr:hover td {
        background-color: #02bfe7;
    }

    table.dataTable.display tbody tr.odd {
        background-color: #D4D4D4 !important;
    }

    #fishTable thead th {
        background-color: white !important;
    }

    tr.selected_fish td {
        background-color: #6baed6 !important;
    }

    div.fishDetails {
        display: inline-block;
        float: left;
        font-size: 12px;
        padding: 5px 5px;
        margin-top: 10px;
        width: 65%;
    }

    table.fishDetails {
        line-height: 12px;
        width: 100%;
        border-color: black;
        border-style: solid;
        border-width: 0px;
        border-radius: 5px;
        background-color: #DBF1FF;
    }

    table.fishDetails col:nth-child(even) {
        background-color: white !important;
        width: 15%;
        min-width: 50px;
    }

    table.fishDetails col:last-child {
        width: 45%;
    }

    table.fishDetails > tbody > tr > td:nth-child(odd):hover, table.fishDetails > tbody > tr > td:nth-child(odd):hover + td {
        background: #BFD2DE;
    }

    table.fishDetails > tbody > tr > td {
        cursor: default;
    }

    .link_image {
        max-width: 25px;
        width: 100%;
        margin: 5px 5px;
    }

    .fish_links {
        display: flex;
        padding: 5px;
    }

    #fish_search_title {
        font-size: 14px;
        float: left;
        position: relative
    }

    #fish_weight {
        margin: 0 10px;
        width: 65%;
        padding-left: 3px;
        float: right;
    }

    #fish_length {
        margin: 3px 10px 0 10px;
        width: 65%;
        padding-left: 3px;
        float: right;
    }

    div #fish_weight_length {
        float: right;
        width: 33%;
        font-size: 12px;
        margin-top: 55px;
        border-color: black;
        border-width: 0px;
        border-style: solid;
        border-radius: 5px;
        background: #DBF1FF;
        padding: 15px 10px 15px 10px;
        display: none;
    }

    #fish_weight_length * label {
        float: left !important;
        display: inline-block !important;
    }

    div.dataTables_scrollBody {
        display: inline-block;
        height: 100%;
    }

    {#    Loader    #}
    #loader {
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 9999;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 100px;
        height: 100px;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
        transition: ease-in-out;
    }

    #loader_background {
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 995;
        position: absolute;
        height: 625px;
        width: 100%;
    }

    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .leaflet-bar {
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65) !important;
        border-radius: 0px !important;
        border-bottom-left-radius: 5px !important;
        border-bottom-right-radius: 5px !important;
    }

    #huc_table_title {
        margin-bottom: 0;
        {#padding-bottom: 10px#}
    }

</style>

<head>
{% load static %}
    <!-- jquery -->
    <script src="{% static 'scripts/jquery-3.2.1.min.js' %}"></script>

    <!-- datatables import -->
    <link rel="stylesheet"
          href="https://www.epa.gov/sites/all/libraries/js/datatables/media/css/jquery.dataTables.min.css">
    <script src="https://www.epa.gov/sites/all/libraries/js/datatables/media/js/jquery.dataTables.min.js"></script>

    <!-- local js -->
    <script src="{% static 'scripts/huc8_simplified_sorted.js' %}"></script>
    <script src="{% static 'scripts/pisces_datatable.js' %}"></script>

</head>

<body>
<div class="panel-display panel-1col clearfix">
    <div class="panel-panel panel-col">

        <!-- leaflet import -->
        <link rel="stylesheet" href="{% static 'css/leaflet.css' %}"/>
        <script src="{% static 'scripts/leaflet.js' %}"></script>
        <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.1/esri-leaflet.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.1/esri-leaflet-geocoder.css">
        <script src="https://cdn.jsdelivr.net/leaflet.esri.geocoder/2.1.1/esri-leaflet-geocoder.js"></script>

        <!--- content div -->
        <div class="col-md-10">
            <div id="loader" style="display:none;"></div>
            <div id="loader_background" style="display:none"></div>
            <div class="box multi news" id="view_block">
                <div class="pane-content" id="mapDiv">
                    <p id="huc_table_title"><strong>Select a HUC 8 watershed</strong> on the map to view a list of fish
                        species associated
                        with the area.</p>
                    <!-- leaflet map div -->
                    <div id="map" class="mapNoTransition"></div>
                    <!-- basemap wrapper -->
                    <div id="basemaps-wrapper" class="leaflet-bar">
                        <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)" title="Base Map">
                            <option value="Topographic">Topographic</option>
                            <option value="Imagery">Imagery</option>
                            <option value="Streets">Streets</option>
                            <option value="NationalGeographic">National Geographic</option>
                            <option value="ShadedRelief">Shaded Relief</option>
                        </select>
                    </div>
                    <br>
                </div>
                <div class="fishSearch">
                    <div>
                        <form class="searchForm" onsubmit="return false;">
                            <input class="fishSearchBox" type="text" name="fish_search"
                                   placeholder="Search for fish species..." title="Fish common or scientific name">
                            <input class="fishSearchButton" type="button" title="Search">
                        </form>
                    </div>
                    <div class="fishTable" style="display:none;">
                        <h5 align="center" id="fish_search_title">Fish in selected HUC</h5>
                        <table id="fishTable" class="display compact hover" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th>Common Name</th>
                                <th>Scientific Name</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div id="selectedFishTable" class="fishDetails"></div>
                <div id="fish_weight_length" style="display: none;">
                    <h4 style="padding-left: 4px">Weight - Length Calculator</h4>
                    <div style="padding: 10px 10px;margin-bottom: 10px;"><label for="fish_weight">Weight
                        (g): </label><input type="text" id="fish_weight" title="Fish Weight"
                                            placeholder="Fish weight...">
                    </div>
                    <div style="padding: 0px 10px;margin-bottom: 10px;"><label for="fish_length"
                                                                               style="margin-top: 3px;">Length
                        (cm): </label><input type="text" id="fish_length" title="Fish Length"
                                             placeholder="Fish length...">
                    </div>
                </div>
            </div>
        </div>

        <script>

            //Weight-length coefficients
            var a = 0;
            var b = 0;

            var fishTableClick;

            $(document).ready(function () {
                // On click event for fish list
                $('#fishTable').on('click', 'tr', function () {
                    startLoad();
                    $('#fish_weight').val("");
                    $('#fish_length').val("");
                    fishTableClick = this;
                    setTimeout(setFishTable, 100);
                    return false;
                });
                // on click event for fish search button
                $('.fishSearchButton').on('click', function () {
                    startLoad();
                    setTimeout(searchForFish, 100);
                    return false;
                });
                // on submit event for fish search button
                $('.searchForm').on('submit', function () {
                    startLoad();
                    setTimeout(searchForFish, 100);
                    return false;
                });

                $('#fish_weight').keyup(calculateFishLength);
                $('#fish_length').keyup(calculateFishWeight);
            });

            $('#fish_weight_length').hide();
            $('.fishTable').closest('div').hide();

            function setFishTable() {
                var e = fishTableClick;
                $('#fishTable').DataTable().rows().nodes().to$().removeClass('selected_fish');
                var fish = $('#fishTable').DataTable().row(e).data();
                getFishDetails(fish);

                $('#fishTable').DataTable().row(e).nodes().to$().addClass('selected_fish');
                $('#fish_weight_length').show();
                $('#selectedFishTable').show();

            }

            //style HUC 8 polygon
            function getColor(d) {
                return '#93D4BC'
            }

            //style HUC 8 polygon cont.
            function hucStyle(feature) {
                return {
                    fillColor: getColor(feature.properties.NumbSpc),
                    weight: .3,
                    opacity: 0.9,
                    color: 'black',
                    fillOpacity: 0.3
                };
            }

            //style selected HUC 8 polygon
            function selectHUCs(hucs) {
{#                                hucs = ["01010001", "02010004", "02010006", "04010101", "04010102", "04010201", "04010301", "04010302", "04020101", "04020102", "04020103", "04020104", "04020105", "04020201", "04020202", "04020203", "04020300", "04030101", "04030102", "04030103", "04030104", "04030105", "04030106", "04030107", "04030108", "04030109", "04030110", "04030111", "04030112", "04030201", "04030202", "04030203", "04040001", "04040002", "04040003", "04050001", "04050002", "04050003", "04050005", "04050006", "04050007", "04060101", "04060102", "04060103", "04060104", "04060105", "04060106", "04060107", "04070002", "04070004", "04070005", "04070006", "04070007", "04080101", "04080102", "04080103", "04080104", "04080201", "04080202", "04080204", "04080205", "04080300", "04090001", "04090002", "04090003", "04090004", "04090005", "04100001", "04100002", "04100003", "04100006", "04100007", "04100010", "04100011", "04110002", "04110003", "04120101", "04120102", "04120103", "04120104", "04120200", "04130001", "04130003", "04140101", "04140102", "04140201", "04140202", "04150102", "04150301", "04150302", "04150306", "05010001", "05010002", "05010004", "05030103", "05040001", "05040002", "05040006", "05080001", "05120104", "05120105"];#}
                $('#fish_weight_length').hide();
                $('#selectedFishTable').hide();
                resetHUCLayer();
                if (hucs.length > 1) {
                    document.getElementById('huc_table_title').innerHTML = "<strong>HUC range for selected fish.</strong> ";
                }
                else {
                    {#var link = "https://cfpub.epa.gov/surf/huc.cfm?huc_code=" + hucs[0];#}
                    {#var link = "https://waterdata.usgs.gov/nwis/inventory/?site_no=" + hucs[0];#}
                    var link = "https://water.usgs.gov/lookup/getwatershed?" + hucs[0]
                    document.getElementById('huc_table_title').innerHTML = "<strong>HUC 8 watershed: </strong>" + "<a href=" + link + " title='Get details of HUC.' target='_blank'>" + hucs[0] + "</a>";
                }
                var layerGroup = [];
                var hucObject = huc8Layer.getLayers();
                var l = 46; // layers start at layerID = 46
                var r = hucObject.length + l;
                $.each(hucs, function (index, value) {
                    var resultIdx = binarySearch(l, r, value);
                    if (resultIdx !== -1) {
                        huc8Layer.getLayer(resultIdx).setStyle({
                            color: 'black',
                            weight: 0.7,
                            fillColor: '#0979D9',
                            fillOpacity: 0.4
                        });
                        layerGroup.push(huc8Layer.getLayer(resultIdx));
                    }
                });
                map.fitBounds(L.featureGroup(layerGroup).getBounds());
            }

            function resetHUCLayer() {
                huc8Layer.eachLayer(function (layer) {
                    huc8Layer.resetStyle(layer);
                });
            }

            function binarySearch(left, right, value) {
                while (left <= right) {
                    var mid = Math.floor((left + right) / 2);
                    if(huc8Layer.hasLayer(mid)) {
                        var midValue = Number(huc8Layer.getLayer(mid).feature.properties.HUC_8);
                        if (Number(midValue) === Number(value)) {
                            return mid;
                        }
                        else if (Number(midValue) > Number(value)) {
                            right = mid - 1;
                        }
                        else {
                            left = mid + 1;
                        }
                    }
                    else {
                        return -1
                    }
                }
                return -1;
            }

            var currentHUC = null;

            function onEachFeatureClick(feature, layer) {
                layer.on('click', function (e) {
                    $('.fishSearchBox').val("");
                    if (this.currentHUC !== feature.properties.HUC_8 || this.currentHUC === null) {
                        this.currentHUC = feature.properties.HUC_8;
                        var hucs = [];
                        hucs.push(feature.properties.HUC_8);
                        selectHUCs(hucs);
                        getFishDataonMapClick(feature.properties.HUC_8);
                    }
                    else {
                        $('.fishTable').closest('div').hide();
                        $('#fish_weight_length').hide();
                        document.getElementById('selectedFishTable').innerHTML = null;
                        resetHUCLayer();
                        this.currentHUC = null;
                    }
                });
            }

            // initialize the map
            var map = L.map('map', {renderer: L.svg({padding: 100})}).setView([40.265306, -98.623725], 4);

            // load basemap
            L.esri.basemapLayer('Topographic')
                .addTo(map);

            // load huc watershed boundaries

            var huc8Layer = L.geoJson(huc8s, {
                style: hucStyle,
                onEachFeature: onEachFeatureClick
            }).addTo(map);

            //basemap selection toolbar
            var layerESRI = L.esri.basemapLayer('Imagery');
            var layerLabels;

            function setBasemap(basemap) {
                if (layerESRI) {
                    map.removeLayer(layerESRI);
                }
                layerESRI = L.esri.basemapLayer(basemap);
                map.addLayer(layerESRI);
                if (layerLabels) {
                    map.removeLayer(layerLabels);
                }
                if (basemap === 'ShadedRelief' || basemap === 'Imagery' || basemap === 'Terrain') {
                    layerLabels = L.esri.basemapLayer(basemap + 'Labels');
                    map.addLayer(layerLabels);
                }
            }

            function changeBasemap(basemaps) {
                var basemap = basemaps.value;
                setBasemap(basemap);
            }

            // -------- FISH Functions ---------- //

            function getFishDataonMapClick(huc8) {
                getFishData(huc8);
            }

            function getFishData(huc8) {
                $.ajax({
                    type: "GET",
                    url: "/pisces/rest/api/v1/fish/hucs/" + huc8,
                    crossDomain: true,
                    success: function (data) {
                        document.getElementById('fish_search_title').innerHTML = "Fish in selected HUC 8";
                        populateFishTable(data);
                    },
                    error: function (jqXHR, status) {
                        console.log("ERROR: failed to get fish data for huc: " + huc8);
                        $('#error_msg').html("Error: failed to get fish data for the selected huc.");
                        return null;
                    }
                });
            }

            function populateFishTable(data) {
                $('#fishTable').DataTable().destroy();
                $('#fishTable').empty();
                var fishData = data["species"];
                var config = {
                    data: fishData,
                    "columns": [
                        {
                            data: "speciesid",
                            title: "Species ID",
                            name: "species_id"
                        },
                        {
                            data: "common_name",
                            title: "Common Name",
                            name: "common_name"
                        },
                        {
                            data: "scientific_name",
                            title: "Scientific Name",
                            name: "scientific_name"
                        },
                        {
                            data: "genus",
                            title: "Genus",
                            name: "genus"
                        }
                    ],
                    "columnDefs": [
                        {
                            "render": function (data, type, row) {
                                return row["genus"] + " " + data;
                            },
                            "targets": 2
                        },
                        {
                            "targets": [0, 3],
                            "visible": false
                        }
                    ],
                    scrollY: true,
                    searching: false,
                    paging: false,
                    bInfo: false,
                    "order": [[0, 'asc']]
                };
                $('.fishTable').closest('div').show();
                $('#fishTable').DataTable(config);
            }

            function getFishDetails(fish) {
                $.ajax({
                    type: "GET",
                    url: "/pisces/rest/api/v1/fish/properties/" + fish["speciesid"].toString(),
                    crossDomain: true,
                    success: function (data) {
                        a = data["species"][0]["w_l_a"];
                        b = data["species"][0]["w_l_b"];
                        setFishDetails(data["species"][0]);
                        searchFishHuc(data["species"][0]["speciesid"]);

                        $('#fish_weight_length').show();
                        $('#selectedFishTable').show();
                    },
                    error: function (jqXHR, status) {
                        console.log("ERROR: failed to get fish detail for speciesid: " + fish["speciesid"]);
                        $('#error_msg').html("Error: failed to get fish details for the selected fish.");
                        return null;
                    }
                });
            }

            function setFishDetails(details) {
                $('#fish_length').val("");
                $('#fish_width').val("");
                var cName = capitalize_Words(details["commonname"]);
                var sName = capitalize_Words(details["genus"] + " " + details["species"]);
                var d = document.getElementById('selectedFishTable');

                // biogeography
                var native = (details["native"] === "Y") ? " Native" : " Introduced";

                // gradient
                var gradient = [];
                if (details["lowlands_lgr"] === "1") gradient.push(" Lowlands");
                if (details["uplands_hgr"] === "1") gradient.push(" Uplands");

                // thermal
                var thermal = [];
                if (details["warmwater"] === "1") thermal.push(" Warmwater");
                if (details["coolwater"] === "1") thermal.push(" Coolwater");
                if (details["coldwater"] === "1") thermal.push(" Coldwater");

                // clarity
                var clarity = [];
                if (details["clearwater"] === "1") clarity.push(" Clear");
                if (details["turbidwater"] === "1") clarity.push(" Turbid");

                // system
                var system = [];
                if (details["caves"] === "1") system.push(" Caves");
                if (details["springs"] === "1") system.push(" Springs");
                if (details["headwaters"] === "1") system.push(" Headwaters");
                if (details["creeks"] === "1") system.push(" Creeks");
                if (details["small_riv"] === "1") system.push(" Small Rivers");
                if (details["med_riv"] === "1") system.push(" Medium Rivers");
                if (details["lge_riv"] === "1") system.push(" Large Rivers");
                if (details["lk_imp_pnd"] === "1") system.push(" Lakes/Impoundments/Ponds/Canals/Ditches");
                if (details["swp_msh_by"] === "1") system.push(" Swamps/Marshes/Bayou");
                if (details["coast_ocea"] === "1") system.push(" Coastal/Ocean");


                // lotic habitat
                var lotic = [];
                if (details["riffles"] === "1") lotic.push(" Riffles");
                if (details["run_flopool"] === "1") lotic.push(" Runs/Flowing Pools");
                if (details["pool_bckwtr"] === "1") lotic.push(" Pools/Backwaters");

                // water column
                var column = [];
                if (details["benthic"] === "1") column.push(" Benthic");
                if (details["surface"] === "1") column.push(" Surface");
                if (details["nrshre_litt"] === "1") column.push(" Nearshore/Littoral");
                if (details["opnwtr_pelag"] === "1") column.push(" Open Water/Pelagic");

                // substrate
                var substrate = [];
                if (details["mud_slt_det"] === "1") substrate.push(" Mud/Silt/Detritus");
                if (details["sand"] === "1") substrate.push(" Sand");
                if (details["gravel"] === "1") substrate.push(" Gravel");
                if (details["rck_rub_bol"] === "1") substrate.push(" Rocks/Rubble/Boulders");
                if (details["vegetation"] === "1") substrate.push(" Vegetation");
                if (details["wdyd_brush"] === "1") substrate.push(" Woody Debris/Brush");

                // tolerance
                {#var tolerance = [];#}
                {#if (details["pollut_tol"] === "I") tolerance.push(" Intolerant");#}
                {#if (details["pollut_tol"] === "T") tolerance.push(" Tolerant");#}
                {#if (details["pollut_tol"] === "M") tolerance.push(" Mid-Tolerant");#}
                {#if (details["pollut_tol"] === "U") tolerance.push(" Unspecified");#}

                // use
                var use = [];
                if (details["sportfishing"] === "1") use.push(" Sportfishing");
                if (details["nongame"] === "1") use.push(" Nongame");
                if (details["subsis_fish"] === "1") use.push(" Subsistence");

                var ubiquity = (details["ubiquity"] == null) ? "NA" : details["ubiquity"].toFixed(1);
                var extent = (details["extent"] == null) ? "NA" : details["extent"].toFixed(1);
                var tolerance = (details["tolerance"] == null) ? "NA" : details["tolerance"].toFixed(1);
                var robustness = (details["robustness"] == null) ? "NA" : details["robustness"].toFixed(1);


                // links
                var google_link = "https://www.google.com/search?tbm=isch&q=" + sName.replace(" ", "+");
                var wiki_link = "https://en.wikipedia.org/wiki/Special:Search/" + sName.replace(" ", "_");

                d.innerHTML = '<h4>' + capitalize_Words(cName) + '</h4>' +
                    '<h5>' + capitalize_Words(sName) + '</h5><p>' +
                    '<table class="fishDetails"><col><col><col><col><tr><td>Tribe</td><td>' + details["group"] + '</td><td>Gradient</td><td>' + gradient.toString() + '</td></tr>' +
                    '<tr><td>Max Length (cm)</td><td> ' + details["max_length"].toFixed(1) + ' </td><td>Human Use</td><td>' + use.toString() + '</td></tr>' +
                    '<tr><td>Mean Weight (g)</td><td>' + details["mean_weight"].toFixed(1) + '</td><td>Biogeography</td><td>' + native + '</td></tr>' +
                    '<tr><td>Mean Length (cm)</td><td>' + details["mean_length"].toFixed(1) + '</td><td>System</td><td>' + system.toString() + '</td></tr>' +
                    '<tr><td>Max Age (yr)</td><td>' + details["max_age"] + '</td><td>Lotic Habitat</td><td>' + lotic.toString() + '</td></tr>' +
                    '<tr><td>A (W=A*L<sup>B</sup>)</td><td>' + details["w_l_a"] + '</td><td>Water Column</td><td>' + column.toString() + '</td></tr>' +
                    '<tr><td>B (W=A*L<sup>B</sup>)</td><td>' + details["w_l_b"] + '</td><td>Substrate</td><td>' + substrate.toString() + '</td></tr>' +
                    '<tr><td>PFG Rarity</td><td>' + details["rarity"] + '</td><td>Water Clarity</td><td>' + clarity.toString() + '</td></tr>' +
                    '<tr><td>Ubiquity</td><td>' + ubiquity + '</td><td>Thermal</td><td>' + thermal.toString() + '</td></tr>' +
                    '<tr><td>Extent</td><td>' + extent + '</td><td>Habitat Notes</td><td>' + details["habit_notes"] + '</td></tr>' +
                    '<tr><td>Tolerance</td><td>' + tolerance + '</td><td></td><td></td></tr>' +
                    '<tr><td>Robustness</td><td>' + robustness + '</td><td></td><td></td></tr></table>' +
                    '<div class="fish_links">Links for additional information on ' + capitalize_Words(cName) + ': <a href="' + google_link + '" target="_blank"><img class="link_image" src="{% static 'images/google_logo.png' %}" alt="Google Images" title="Link to Google Images"></a>' +
                    '<a href="' + wiki_link + '" target="_blank"><img class="link_image" src="{% static 'images/wikipedia_logo.png' %}" alt="Wikipedia page" title="Link to Wikipedia page"></a></div>'
                ;
            }

            function capitalize_Words(str) {
                return str.replace(/\w\S*/g, function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                });
            }

            function calculateFishWeight() {
                var L = $('#fish_length').val();
                if ($.isNumeric(L) && L !== "") {
                    var weight = (a * Math.pow(L, b)).toFixed(1);
                    $('#fish_weight').val(weight);
                }
                else {
                    $('#fish_weight').val("");
                }
            }

            function calculateFishLength() {
                var W = $('#fish_weight').val();
                if ($.isNumeric(W) && W !== "") {
                    var length = Math.pow(W / a, 1 / b).toFixed(1);
                    $('#fish_length').val(length);
                }
                else {
                    $('#fish_length').val("");
                }
            }

            function searchForFish() {
                var fish = $('.fishSearchBox').val();
                resetHUCLayer();
                var fishrequest = JSON.stringify({"search_string": fish});
                console.log(fishrequest);
                $.ajax({
                    type: "POST",
                    url: "/pisces/rest/api/v1/fish/properties/names/",
                    data: fishrequest,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    crossDomain: true,
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    },
                    success: function (data) {
                        document.getElementById('fish_search_title').innerHTML = "Search results for: " + fish;
                        populateFishTable(data);
                    },
                    error: function (jqXHR, status) {
                        console.log("ERROR: failed to get fish data from search: " + fish);
                        $('#error_msg').html("Error: failed to query for provided string.");
                        return null;
                    },
                    complete: function (jgXHR, status) {
                        $('#selectedFishTable').hide();
                        $('#fish_weight_length').hide();
                        endLoad();
                    }
                });

            }

            function searchFishHuc(speciesID) {
                $.ajax({
                    type: "GET",
                    url: "/pisces/rest/api/v1/hucs/fish/" + speciesID,
                    crossDomain: true,
                    async: false,
                    success: function (data) {
                        var hucs = data["hucs"].map(function (h) {
                            return h["huc"];
                        });
                        selectHUCs(hucs)
                    }
                    ,
                    error: function (jqXHR, status) {
                        console.log("ERROR: failed to get huc list for fish:" + speciesID);
                        $('#error_msg').html("Error: failed to get huc list for the specified fish.");
                        return null;
                    }
                    ,
                    complete: function (jqXHR, status) {
                        endLoad();
                    }
                })
                ;
            }

            var loadScreen;

            function startLoad() {
                document.getElementById("loader").style.display = "block";
                document.getElementById("loader_background").style.display = "block";
                loadScreen = setTimeout(endLoad, 30000)
            }

            function endLoad() {
                document.getElementById("loader").style.display = "none";
                document.getElementById("loader_background").style.display = "none";
                clearTimeout(loadScreen);
            }

            // CSRF Handling
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            // NOT BEING USED, token being set directly in ajax POST function in searchForFish()
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            // End of CSRF handling

        </script>

    </div>
</div>

</body>
</html>
